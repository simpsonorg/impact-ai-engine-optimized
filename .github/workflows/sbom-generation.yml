name: SBOM Generation & Publication

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  generate-sbom:
    name: Generate SBOM (CycloneDX + SPDX + SBOM.md)
    runs-on: ubuntu-latest

    permissions:
      contents: write     # Required to allow commit back into the repo
      actions: read

    steps:
      # ------------------------------------------------------
      # 1. Checkout
      # ------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # 2. Setup Python
      # ------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ------------------------------------------------------
      # 3. Install dependencies (your application)
      # ------------------------------------------------------
      - name: Install Python dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "requirements.txt not found â€” skipping app dependency installation."
          fi

      # ------------------------------------------------------
      # 4. Install SBOM tools
      # ------------------------------------------------------
      - name: Install SBOM tooling
        run: |
          pip install cyclonedx-bom==4.0.1 cyclonedx-python-lib
          pip install pip-licenses

      # ------------------------------------------------------
      # 5. Create sbom-report directory (this is the folder you want)
      # ------------------------------------------------------
      - name: Prepare sbom-report directory
        run: mkdir -p sbom-report

      # ------------------------------------------------------
      # 6. Generate CycloneDX SBOM (JSON)
      # ------------------------------------------------------
      - name: Generate CycloneDX SBOM (JSON)
        run: |
          cyclonedx-py \
            --force \
            --format json \
            --output sbom-report/sbom-cyclonedx.json

      # ------------------------------------------------------
      # 7. Generate SPDX-style license report
      # ------------------------------------------------------
      - name: Generate SPDX-style license report
        run: |
          pip-licenses \
            --format=markdown \
            --with-urls \
            --with-license-file > sbom-report/sbom-licenses.spdx.md

      # ------------------------------------------------------
      # 8. Generate rich SBOM.md (human-readable)
      # ------------------------------------------------------
      - name: Generate SBOM.md summary
        run: |
          cat > sbom-report/SBOM.md << 'EOF'
          # ðŸ“¦ Software Bill of Materials â€“ Impact Delphyne

          Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          Repository: https://github.com/simpsonorg/impact-ai-engine-optimized

          ## Overview
          This SBOM describes all code, dependencies, external modules, LLM models, RAG components,
          knowledge graph components, CI pipelines, microservice integrations, and tooling 
          used by the Impact Delphyne Impact Analyzer Engine.

          ## Included SBOM Files
          - sbom-cyclonedx.json  (CycloneDX full JSON SBOM)
          - sbom-licenses.spdx.md (SPDX-style license overview)
          - SBOM.md (this document)

          ## Runtime Dependencies
          - networkx
          - numpy
          - openai
          - faiss-cpu
          - pyyaml
          - esprima
          - GitPython
          - fastapi
          - uvicorn
          - psycopg2
          - requests
          - pytest

          ## LLM Models
          - gpt-4o-mini for PR analysis
          - text-embedding-3-small for embeddings

          ## RAG Components
          - Chunking pipeline
          - Embeddings pipeline
          - Vector store (FAISS or pgvector)
          - Retriever (top-k semantic similarity search)

          ## Knowledge Graph Components
          - Directed graph via NetworkX
          - PageRank, centrality, impact propagation
          - Node classification (service, endpoint, file, contract)
          - Edge mapping from imports, URLs, OpenAPI, proto

          ## CI/CD Integration
          - PR impact analysis workflow
          - SARIF/JSON artifact generation
          - GitHub Actions automation

          This SBOM provides a complete system-level overview of the project architecture,
          dependencies, and operational components.
          EOF

      # ------------------------------------------------------
      # 9. Upload artifacts
      # ------------------------------------------------------
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-report
          path: sbom-report/

      # ------------------------------------------------------
      # 10. Commit sbom-report back into repository
      # ------------------------------------------------------
      - name: Commit SBOM directory back to repo
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          
          git add sbom-report
          git commit -m "Automated SBOM update [CI]" || echo "No changes to commit"
          git push origin HEAD || echo "Nothing to push"
