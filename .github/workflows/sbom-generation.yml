      # ------------------------------------------------------
      # 9. Generate HTML SBOM Dashboard (Upgraded Version)
      # ------------------------------------------------------
      - name: Generate HTML SBOM Dashboard
        run: |
          python - << 'EOF'
          import json, os, collections, datetime

          sbom_path = "sbom-report/sbom-cyclonedx.json"
          out_path = "sbom-report/sbom-dashboard.html"

          with open(sbom_path, "r") as f:
              data = json.load(f)

          components = data.get("components", [])
          total_components = len(components)

          by_type = collections.Counter(c.get("type", "library") for c in components)
          by_license = collections.Counter()

          for c in components:
              lic = "Unknown"
              lic_obj = c.get("license") or c.get("licenses")
              if isinstance(lic_obj, dict):
                  lic = lic_obj.get("id") or lic_obj.get("name") or "Unknown"
              elif isinstance(lic_obj, list) and lic_obj:
                  ent = lic_obj[0]
                  if isinstance(ent, dict):
                      lic = ent.get("id") or ent.get("name") or "Unknown"
              by_license[lic] += 1

          now = datetime.datetime.utcnow().isoformat() + "Z"

          # Convert for Chart.js
          types_labels = list(by_type.keys())
          types_values = list(by_type.values())

          lic_labels = list(by_license.keys())
          lic_values = list(by_license.values())

          html = f"""
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <title>SBOM Dashboard – Impact Delphyne</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
              body {{
                margin: 0;
                background: #0f172a;
                color: #e2e8f0;
                font-family: system-ui;
              }}
              header {{
                padding: 24px 32px;
                background: linear-gradient(90deg,#6366f1,#8b5cf6,#d946ef);
                color: white;
                box-shadow: 0 4px 20px rgba(0,0,0,0.4);
              }}
              header h1 {{
                margin: 0;
                font-size: 2rem;
                font-weight: 700;
              }}
              header p {{
                margin: 6px 0 0 0;
                opacity: 0.9;
              }}

              .container {{
                padding: 24px 32px;
              }}

              /* Cards */
              .cards {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
              }}
              .card {{
                backdrop-filter: blur(18px);
                background: rgba(255,255,255,0.05);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 16px;
                padding: 20px;
                transition: 0.3s;
              }}
              .card:hover {{
                transform: translateY(-4px);
                box-shadow: 0 8px 30px rgba(0,0,0,0.4);
              }}
              .card h2 {{
                font-size: 1rem;
                margin-bottom: 6px;
                color: #c7d2fe;
              }}
              .card .value {{
                font-size: 1.8rem;
                font-weight: bold;
              }}

              /* Section Title */
              h2.section-title {{
                font-size: 1.4rem;
                margin-top: 0;
                color: #a78bfa;
              }}

              /* Search box */
              .search-box {{
                margin-bottom: 16px;
              }}
              .search-box input {{
                width: 100%;
                padding: 10px 14px;
                border-radius: 10px;
                border: 1px solid #334155;
                background: #1e293b;
                color: #e2e8f0;
                font-size: 1rem;
              }}

              /* Table */
              table {{
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                font-size: 0.95rem;
              }}
              th {{
                text-align: left;
                background: #1e293b;
                color: #a5b4fc;
                padding: 10px;
                position: sticky;
                top: 0;
              }}
              td {{
                padding: 8px;
                border-bottom: 1px solid #334155;
              }}
              tr:hover td {{
                background: rgba(255,255,255,0.04);
              }}

              .pill {{
                padding: 3px 10px;
                border-radius: 12px;
                font-size: 0.75rem;
              }}
              .pill.type {{ background: #1d4ed8; color: #fff; }}
              .pill.license {{ background: #047857; color: #bbf7d0; }}

              /* Charts */
              .chart-container {{
                margin: 30px 0;
                padding: 20px;
                background: rgba(255,255,255,0.05);
                border-radius: 16px;
                border: 1px solid rgba(255,255,255,0.08);
              }}

              footer {{
                margin-top:40px;
                padding: 20px 32px;
                font-size: 0.85rem;
                text-align:center;
                color:#94a3b8;
                border-top: 1px solid #1e293b;
              }}
            </style>
          </head>
          <body>
            
            <header>
              <h1>Impact Delphyne – SBOM Dashboard</h1>
              <p>Generated at {now}</p>
            </header>

            <div class="container">

              <div class="cards">
                <div class="card">
                  <h2>Total Components</h2>
                  <div class="value">{total_components}</div>
                </div>

                <div class="card">
                  <h2>Unique Component Types</h2>
                  <div class="value">{len(by_type)}</div>
                </div>

                <div class="card">
                  <h2>Unique Licenses</h2>
                  <div class="value">{len(by_license)}</div>
                </div>
              </div>

              <!-- Charts -->
              <div class="chart-container">
                <h2 class="section-title">Component Types Distribution</h2>
                <canvas id="typesChart"></canvas>
              </div>

              <div class="chart-container">
                <h2 class="section-title">License Distribution</h2>
                <canvas id="licenseChart"></canvas>
              </div>

              <!-- Search -->
              <h2 class="section-title">Component Inventory</h2>
              <div class="search-box">
                <input id="searchBox" placeholder="Search components by name, license or type..." onkeyup="filterTable()" />
              </div>

              <!-- Table -->
              <div style="max-height: 500px; overflow: auto;">
                <table id="componentsTable">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th>Version</th>
                      <th>License</th>
                    </tr>
                  </thead>
                  <tbody>
          """

          # Table rows
          for c in components:
              name = c.get("name", "unknown")
              ctype = c.get("type", "library")
              version = c.get("version", "unknown")

              lic = "Unknown"
              lic_obj = c.get("license") or c.get("licenses")
              if isinstance(lic_obj, dict):
                  lic = lic_obj.get("id") or lic_obj.get("name") or "Unknown"
              elif isinstance(lic_obj, list) and lic_obj:
                  ent = lic_obj[0]
                  if isinstance(ent, dict):
                      lic = ent.get("id") or ent.get("name") or "Unknown"

              html += f"""
                <tr>
                  <td>{name}</td>
                  <td><span class="pill type">{ctype}</span></td>
                  <td>{version}</td>
                  <td><span class="pill license">{lic}</span></td>
                </tr>
              """

          # Close HTML
          html += f"""
                  </tbody>
                </table>
              </div>
            </div>

            <footer>
              SBOM Dashboard generated automatically via GitHub Actions.
            </footer>

            <script>
              // Charts
              new Chart(document.getElementById('typesChart'), {{
                type: 'pie',
                data: {{
                  labels: {types_labels},
                  datasets: [{{
                    data: {types_values}
                  }}]
                }}
              }});

              new Chart(document.getElementById('licenseChart'), {{
                type: 'bar',
                data: {{
                  labels: {lic_labels},
                  datasets: [{{
                    data: {lic_values}
                  }}]
                }},
                options: {{
                  scales: {{
                    x: {{ ticks: {{ color: '#e2e8f0' }} }},
                    y: {{ ticks: {{ color: '#e2e8f0' }} }}
                  }}
                }}
              }});

              // Table search filter
              function filterTable() {{
                let filter = document.getElementById("searchBox").value.toLowerCase();
                let rows = document.querySelectorAll("#componentsTable tbody tr");

                rows.forEach(row => {{
                  let text = row.innerText.toLowerCase();
                  row.style.display = text.includes(filter) ? "" : "none";
                }});
              }}
            </script>

          </body>
          </html>
          """

          with open(out_path, "w") as f:
              f.write(html)

          print("Upgraded HTML Dashboard generated:", out_path)
          EOF
