name: SBOM Generation & Publication

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  generate-sbom:
    name: Generate SBOM (CycloneDX + SPDX + HTML Dashboard + VEX)
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read

    steps:
      # ------------------------------------------------------
      # 1. Checkout
      # ------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # 2. Python Setup
      # ------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ------------------------------------------------------
      # 3. Install app dependencies
      # ------------------------------------------------------
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

      # ------------------------------------------------------
      # 4. Install SBOM tools
      # ------------------------------------------------------
      - name: Install CycloneDX + SPDX tooling
        run: |
          pip install cyclonedx-bom cyclonedx-python-lib
          pip install pip-licenses

      # ------------------------------------------------------
      # 5. Prepare sbom-report directory
      # ------------------------------------------------------
      - name: Prepare sbom-report directory
        run: mkdir -p sbom-report

      # ------------------------------------------------------
      # 6. Generate CycloneDX SBOM (JSON)
      # ------------------------------------------------------
      - name: Generate CycloneDX SBOM (JSON)
        run: |
          cyclonedx-py env -o sbom-report/sbom-cyclonedx.json


      # ------------------------------------------------------
      # 7. Generate SPDX License Report
      # ------------------------------------------------------
      - name: Generate SPDX License Report (Markdown)
        run: |
          pip-licenses \
            --format=markdown \
            --with-urls \
            --with-license-file > sbom-report/sbom-licenses.spdx.md

      # ------------------------------------------------------
      # 8. Generate SBOM.md summary
      # ------------------------------------------------------
      - name: Generate SBOM.md Summary
        run: |
          cat > sbom-report/SBOM.md << 'EOF'
          # ðŸ“¦ Software Bill of Materials â€“ Impact Delphyne

          This SBOM bundle includes:
          - CycloneDX SBOM (JSON)
          - SPDX License Report
          - Interactive HTML Dashboard
          - CycloneDX VEX report
          - Human-friendly SBOM.md

          Generated automatically via GitHub Actions.
          EOF

      # ------------------------------------------------------
      # 9. Generate UPGRADED HTML SBOM Dashboard
      # ------------------------------------------------------
      - name: Generate HTML SBOM Dashboard (Interactive)
        run: |
          python - << 'EOF'
          import json, os, collections, datetime

          sbom_path = "sbom-report/sbom-cyclonedx.json"
          out_path = "sbom-report/sbom-dashboard.html"

          with open(sbom_path, "r") as f:
              data = json.load(f)

          components = data.get("components", [])
          total_components = len(components)

          by_type = collections.Counter(c.get("type", "library") for c in components)
          by_license = collections.Counter()

          for c in components:
              lic = "Unknown"
              lic_obj = c.get("license") or c.get("licenses")
              if isinstance(lic_obj, dict):
                  lic = lic_obj.get("id") or lic_obj.get("name") or "Unknown"
              elif isinstance(lic_obj, list) and lic_obj:
                  ent = lic_obj[0]
                  if isinstance(ent, dict):
                      lic = ent.get("id") or ent.get("name") or "Unknown"
              by_license[lic] += 1

          now = datetime.datetime.utcnow().isoformat() + "Z"

          types_labels = list(by_type.keys())
          types_values = list(by_type.values())

          lic_labels = list(by_license.keys())
          lic_values = list(by_license.values())

          html = f"""
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <title>SBOM Dashboard â€“ Impact Delphyne</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
              body {{
                margin: 0;
                background: #0f172a;
                color: #e2e8f0;
                font-family: system-ui;
              }}
              header {{
                padding: 24px 32px;
                background: linear-gradient(90deg,#6366f1,#8b5cf6,#d946ef);
                color: white;
                box-shadow: 0 4px 20px rgba(0,0,0,0.4);
              }}
              header h1 {{
                margin: 0;
                font-size: 2rem;
                font-weight: 700;
              }}
              .container {{
                padding: 24px 32px;
              }}
              .cards {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
              }}
              .card {{
                backdrop-filter: blur(18px);
                background: rgba(255,255,255,0.05);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 16px;
                padding: 20px;
              }}
              .card h2 {{
                font-size: 1rem;
                color: #c7d2fe;
              }}
              .card .value {{
                font-size: 1.8rem;
                font-weight: bold;
              }}
              .chart-container {{
                margin: 30px 0;
                padding: 20px;
                background: rgba(255,255,255,0.05);
                border-radius: 16px;
              }}
              .search-box input {{
                width: 100%;
                padding: 10px;
                border-radius: 10px;
                background: #1e293b;
                border: 1px solid #334155;
                color: white;
              }}
              table {{
                width: 100%;
                border-collapse: collapse;
              }}
              th {{
                background: #1e293b;
                padding: 10px;
                color: #a5b4fc;
              }}
              td {{
                padding: 8px;
                border-bottom: 1px solid #334155;
              }}
              tr:hover td {{
                background: rgba(255,255,255,0.05);
              }}
              .pill.type {{
                background: #1d4ed8;
                padding: 4px 10px;
                border-radius: 8px;
              }}
              .pill.license {{
                background: #047857;
                padding: 4px 10px;
                border-radius: 8px;
              }}
            </style>
          </head>
          <body>
          <header>
            <h1>Impact Delphyne â€“ SBOM Dashboard</h1>
            <p>Generated at {now}</p>
          </header>

          <div class="container">

            <div class="cards">
              <div class="card">
                <h2>Total Components</h2>
                <div class="value">{total_components}</div>
              </div>
              <div class="card">
                <h2>Component Types</h2>
                <div class="value">{len(by_type)}</div>
              </div>
              <div class="card">
                <h2>Unique Licenses</h2>
                <div class="value">{len(by_license)}</div>
              </div>
            </div>

            <div class="chart-container">
              <h2>Component Types Distribution</h2>
              <canvas id="typesChart"></canvas>
            </div>

            <div class="chart-container">
              <h2>License Distribution</h2>
              <canvas id="licenseChart"></canvas>
            </div>

            <h2>Component Inventory</h2>
            <div class="search-box">
              <input id="searchBox" placeholder="Search..." onkeyup="filterTable()" />
            </div>

            <div style="max-height: 500px; overflow:auto">
              <table id="componentsTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Version</th>
                    <th>License</th>
                  </tr>
                </thead>
                <tbody>
          """

          # Add table rows
          for c in components:
              name = c.get("name","unknown")
              ctype = c.get("type","library")
              version = c.get("version","unknown")

              lic = "Unknown"
              lic_obj = c.get("license") or c.get("licenses")
              if isinstance(lic_obj, dict):
                  lic = lic_obj.get("id") or lic_obj.get("name") or "Unknown"
              elif isinstance(lic_obj, list) and lic_obj:
                  ent = lic_obj[0]
                  if isinstance(ent, dict):
                      lic = ent.get("id") or ent.get("name") or "Unknown"

              html += f"""
                <tr>
                  <td>{name}</td>
                  <td><span class='pill type'>{ctype}</span></td>
                  <td>{version}</td>
                  <td><span class='pill license'>{lic}</span></td>
                </tr>
              """

          # Close HTML
          html += f"""
                </tbody>
              </table>
            </div>

          </div>

          <script>
            new Chart(document.getElementById('typesChart'), {{
              type: 'pie',
              data: {{
                labels: {types_labels},
                datasets: [{{ data: {types_values} }}]
              }}
            }});

            new Chart(document.getElementById('licenseChart'), {{
              type: 'bar',
              data: {{
                labels: {lic_labels},
                datasets: [{{ data: {lic_values} }}]
              }}
            }});

            function filterTable() {{
              let filter = document.getElementById("searchBox").value.toLowerCase();
              let rows = document.querySelectorAll("#componentsTable tbody tr");
              rows.forEach(r => {{
                r.style.display = r.innerText.toLowerCase().includes(filter) ? "" : "none";
              }});
            }}
          </script>

          </body>
          </html>
          """

          with open(out_path, "w") as f:
              f.write(html)

          print("Interactive HTML SBOM Dashboard generated:", out_path)
          EOF

      # ------------------------------------------------------
      # 10. Generate CycloneDX VEX Report
      # ------------------------------------------------------
      - name: Generate CycloneDX VEX report
        run: |
          python - << 'EOF'
          import json, os, datetime

          sbom_path = "sbom-report/sbom-cyclonedx.json"
          vex_path = "sbom-report/sbom-vex.json"

          with open(sbom_path,"r") as f:
              sbom=json.load(f)

          components=sbom.get("components",[])
          timestamp=datetime.datetime.utcnow().isoformat()+"Z"

          vulns=[]
          for c in components:
              name=c.get("name","unknown")
              bom_ref=c.get("bom-ref",name)

              vulns.append({
                  "id": f"NO-KNOWN-VULN-{name}",
                  "analysis": {
                      "state":"not_affected",
                      "justification":"no_known_vulnerabilities"
                  },
                  "affects":[{"ref":bom_ref}]
              })

          vex_doc={
              "bomFormat":"CycloneDX",
              "specVersion":"1.5",
              "version":1,
              "metadata":{"timestamp":timestamp},
              "vulnerabilities":vulns
          }

          with open(vex_path,"w") as f:
              json.dump(vex_doc,f,indent=2)

          print("VEX report created:", vex_path)
          EOF

      # ------------------------------------------------------
      # 11. Upload Artifacts
      # ------------------------------------------------------
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-report
          path: sbom-report/

      # ------------------------------------------------------
      # 12. Commit SBOM Directory to Repo
      # ------------------------------------------------------
      - name: Commit SBOM directory back to repo
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add sbom-report
          git commit -m "Automated SBOM update [CI]" || true
          git push || true
