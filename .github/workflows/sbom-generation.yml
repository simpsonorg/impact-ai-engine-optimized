name: SBOM Generation & Publication

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  generate-sbom:
    name: Generate SBOM (CycloneDX + SPDX + SBOM.md + HTML Dashboard + VEX)
    runs-on: ubuntu-latest

    permissions:
      contents: write     # Required to allow commit back into the repo
      actions: read

    steps:
      # ------------------------------------------------------
      # 1. Checkout
      # ------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # 2. Setup Python
      # ------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ------------------------------------------------------
      # 3. Install app dependencies (so SBOM is accurate)
      # ------------------------------------------------------
      - name: Install Python dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install --upgrade pip
            pip install cyclonedx-bom cyclonedx-python-lib
            pip install -r requirements.txt
          else
            echo "requirements.txt not found â€” skipping app dependency installation."
          fi

      # ------------------------------------------------------
      # 4. Install SBOM tools
      # ------------------------------------------------------
      - name: Install SBOM tooling
        run: |
          pip install cyclonedx-bom==4.0.1 cyclonedx-python-lib
          pip install pip-licenses

      # ------------------------------------------------------
      # 5. Create sbom-report directory
      # ------------------------------------------------------
      - name: Prepare sbom-report directory
        run: mkdir -p sbom-report

      # ------------------------------------------------------
      # 6. Generate CycloneDX SBOM (JSON)
      # ------------------------------------------------------
      - name: Generate CycloneDX SBOM (JSON)
        run: |
          cyclonedx-py \
            --force \
            --format json \
            --output sbom-report/sbom-cyclonedx.json

      # ------------------------------------------------------
      # 7. Generate SPDX-style license report
      # ------------------------------------------------------
      - name: Generate SPDX-style license report
        run: |
          pip-licenses \
            --format=markdown \
            --with-urls \
            --with-license-file > sbom-report/sbom-licenses.spdx.md

      # ------------------------------------------------------
      # 8. Generate SBOM.md (rich, human-readable overview)
      # ------------------------------------------------------
      - name: Generate SBOM.md summary
        run: |
          cat > sbom-report/SBOM.md << 'EOF'
          # ðŸ“¦ Software Bill of Materials â€“ Impact Delphyne

          Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          Repository: https://github.com/simpsonorg/impact-ai-engine-optimized

          ## Overview
          This SBOM describes all code, dependencies, external modules, LLM models, RAG components,
          knowledge graph components, CI pipelines, and integrations used by the Impact Delphyne Impact Analyzer Engine.

          ## Included SBOM Files
          - sbom-cyclonedx.json  (CycloneDX full JSON SBOM)
          - sbom-licenses.spdx.md (SPDX-style license overview)
          - SBOM.md (this document)
          - sbom-dashboard.html (HTML visualization)
          - sbom-vex.json (CycloneDX VEX report)

          ## Runtime Dependencies (high level)
          - networkx
          - numpy
          - openai
          - faiss-cpu
          - pyyaml
          - esprima
          - GitPython
          - fastapi
          - uvicorn
          - psycopg2
          - requests
          - pytest

          ## LLM Models (conceptual)
          - gpt-4o-mini for analysis and summary
          - text-embedding-3-small (or configured embedding model) for vector embeddings

          ## RAG Components
          - Chunking pipeline
          - Embeddings pipeline
          - Vector store (FAISS or pgvector)
          - Retriever (top-k semantic similarity search)

          ## Knowledge Graph
          - Directed graph built with NetworkX
          - PageRank and centrality-based ranking
          - Nodes: services, endpoints, files, contracts
          - Edges: imports, URL callouts, OpenAPI/proto relations

          ## CI/CD Integration
          - Impact analysis triggered in pull requests
          - JSON artifact: impact-summary.json
          - PR comment generation for reviewers
          - SBOM artifacts generated by this workflow

          ## Security & Supply Chain
          - External LLM usage (OpenAI APIs)
          - CI secrets should be stored as GitHub Secrets
          - Postgres connections should enforce sslmode=require
          - SBOM artifacts can be used for vulnerability and license scanning
          EOF

      # ------------------------------------------------------
      # 9. Generate HTML SBOM Dashboard (using Python)
      # ------------------------------------------------------
      - name: Generate HTML SBOM Dashboard
        run: |
          python - << 'EOF'
          import json, os, collections, datetime

          sbom_path = "sbom-report/sbom-cyclonedx.json"
          out_path = "sbom-report/sbom-dashboard.html"

          if not os.path.exists(sbom_path):
              raise SystemExit(f"Missing {sbom_path}, cannot build dashboard")

          with open(sbom_path, "r", encoding="utf-8") as f:
              data = json.load(f)

          components = data.get("components", [])
          total_components = len(components)

          by_type = collections.Counter(c.get("type", "library") for c in components)
          by_license = collections.Counter()

          for c in components:
              lic = "Unknown"
              lic_obj = c.get("license") or c.get("licenses")
              if isinstance(lic_obj, dict):
                  lic = lic_obj.get("id") or lic_obj.get("name") or "Unknown"
              elif isinstance(lic_obj, list) and lic_obj:
                  entry = lic_obj[0]
                  if isinstance(entry, dict):
                      lic = entry.get("id") or entry.get("name") or "Unknown"
              by_license[lic] += 1

          now = datetime.datetime.utcnow().isoformat() + "Z"

          html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>SBOM Dashboard â€“ Impact Delphyne</title>
            <style>
              body {{
                font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                background: #0f172a;
                color: #e5e7eb;
                margin: 0;
                padding: 0;
              }}
              header {{
                padding: 24px 32px;
                background: linear-gradient(90deg,#1d4ed8,#7c3aed);
                color: white;
              }}
              header h1 {{
                margin: 0;
                font-size: 1.8rem;
              }}
              header p {{
                margin: 4px 0 0 0;
                opacity: 0.9;
              }}
              .container {{
                padding: 24px 32px 48px 32px;
              }}
              .cards {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 16px;
                margin-bottom: 32px;
              }}
              .card {{
                background: #020617;
                border-radius: 16px;
                padding: 16px 18px;
                border: 1px solid #1e293b;
                box-shadow: 0 18px 30px rgba(15,23,42,0.7);
              }}
              .card h2 {{
                margin: 0 0 8px 0;
                font-size: 1rem;
                color: #a5b4fc;
              }}
              .card .value {{
                font-size: 1.5rem;
                font-weight: 600;
              }}
              .card small {{
                display: block;
                margin-top: 4px;
                color: #64748b;
              }}
              h2.section-title {{
                margin-top: 0;
                margin-bottom: 8px;
                font-size: 1.2rem;
                color: #c4b5fd;
              }}
              .section {{
                margin-bottom: 32px;
              }}
              table {{
                width: 100%;
                border-collapse: collapse;
                font-size: 0.9rem;
              }}
              th, td {{
                padding: 8px 10px;
                border-bottom: 1px solid #1e293b;
              }}
              th {{
                text-align: left;
                background: #020617;
                color: #818cf8;
                position: sticky;
                top: 0;
                z-index: 1;
              }}
              tr:nth-child(even) td {{
                background: #020617;
              }}
              tr:nth-child(odd) td {{
                background: #020617;
              }}
              .pill {{
                display: inline-block;
                padding: 2px 8px;
                border-radius: 999px;
                font-size: 0.75rem;
                background: #1e293b;
              }}
              .pill.license {{
                background: #022c22;
                color: #6ee7b7;
              }}
              .pill.type {{
                background: #1e293b;
                color: #93c5fd;
              }}
              footer {{
                padding: 16px 32px;
                font-size: 0.8rem;
                color: #6b7280;
                border-top: 1px solid #111827;
              }}
              a {{
                color: #60a5fa;
              }}
            </style>
          </head>
          <body>
            <header>
              <h1>SBOM Dashboard â€“ Impact Delphyne</h1>
              <p>Generated at {now}</p>
            </header>
            <div class="container">
              <div class="cards">
                <div class="card">
                  <h2>Total Components</h2>
                  <div class="value">{total_components}</div>
                  <small>From CycloneDX SBOM</small>
                </div>
                <div class="card">
                  <h2>Component Types</h2>
                  <div class="value">{len(by_type)}</div>
                  <small>{", ".join(f"{k}: {v}" for k,v in by_type.items())}</small>
                </div>
                <div class="card">
                  <h2>Licenses</h2>
                  <div class="value">{len(by_license)}</div>
                  <small>{", ".join(f"{k}: {v}" for k,v in by_license.items())}</small>
                </div>
              </div>

              <div class="section">
                <h2 class="section-title">Component Inventory</h2>
                <div style="max-height: 420px; overflow: auto; border-radius: 12px; border: 1px solid #1f2937;">
                  <table>
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Version</th>
                        <th>License</th>
                      </tr>
                    </thead>
                    <tbody>
          """

          for c in components:
              name = c.get("name", "unknown")
              ctype = c.get("type", "library")
              version = c.get("version", "unknown")
              lic = "Unknown"
              lic_obj = c.get("license") or c.get("licenses")
              if isinstance(lic_obj, dict):
                  lic = lic_obj.get("id") or lic_obj.get("name") or "Unknown"
              elif isinstance(lic_obj, list) and lic_obj:
                  entry = lic_obj[0]
                  if isinstance(entry, dict):
                      lic = entry.get("id") or entry.get("name") or "Unknown"

              html += f"""
                      <tr>
                        <td>{name}</td>
                        <td><span class="pill type">{ctype}</span></td>
                        <td>{version}</td>
                        <td><span class="pill license">{lic}</span></td>
                      </tr>
              """

          html += """
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <footer>
              SBOM Dashboard generated from CycloneDX document (sbom-cyclonedx.json).
            </footer>
          </body>
          </html>
          """

          os.makedirs(os.path.dirname(out_path), exist_ok=True)
          with open(out_path, "w", encoding="utf-8") as f:
              f.write(html)
          print(f"HTML SBOM Dashboard written to {out_path}")
          EOF

      # ------------------------------------------------------
      # 10. Generate CycloneDX-style VEX report (simple not_affected template)
      # ------------------------------------------------------
      - name: Generate CycloneDX VEX report
        run: |
          python - << 'EOF'
          import json, os, datetime

          sbom_path = "sbom-report/sbom-cyclonedx.json"
          vex_path = "sbom-report/sbom-vex.json"

          if not os.path.exists(sbom_path):
              raise SystemExit(f"Missing {sbom_path}, cannot build VEX")

          with open(sbom_path, "r", encoding="utf-8") as f:
              sbom = json.load(f)

          components = sbom.get("components", [])
          timestamp = datetime.datetime.utcnow().isoformat() + "Z"

          vulnerabilities = []
          for c in components:
              name = c.get("name", "unknown")
              bom_ref = c.get("bom-ref", name)

              # This template assumes no known exploitable vulnerabilities
              # and declares them as not_affected for demonstration.
              vul = {
                  "id": f"NO-KNOWN-VULN-{name}",
                  "source": {
                      "name": "internal-sbom-vex-generator"
                  },
                  "analysis": {
                      "state": "not_affected",
                      "justification": "no_known_vulnerabilities",
                      "response": ["will_not_fix"]
                  },
                  "affects": [
                      {
                          "ref": bom_ref
                      }
                  ]
              }
              vulnerabilities.append(vul)

          vex_doc = {
              "bomFormat": "CycloneDX",
              "specVersion": sbom.get("specVersion", "1.5"),
              "version": 1,
              "metadata": {
                  "timestamp": timestamp,
                  "component": sbom.get("metadata", {}).get("component", {}),
                  "tools": [
                      {
                          "vendor": "internal",
                          "name": "impact-delphyne-sbom-vex-generator"
                      }
                  ]
              },
              "vulnerabilities": vulnerabilities
          }

          with open(vex_path, "w", encoding="utf-8") as f:
              json.dump(vex_doc, f, indent=2)
          print(f"VEX report written to {vex_path}")
          EOF

      # ------------------------------------------------------
      # 11. Upload artifacts
      # ------------------------------------------------------
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-report
          path: sbom-report/

      # ------------------------------------------------------
      # 12. Commit sbom-report back into repository
      # ------------------------------------------------------
      - name: Commit SBOM directory back to repo
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          
          git add sbom-report
          git commit -m "Automated SBOM update [CI]" || echo "No changes to commit"
          git push origin HEAD || echo "Nothing to push"
